// BV SHOP 出貨助手 - 使用 Canvas API 直接截圖
(function() {
  'use strict';

  // 檢查頁面
  function isKTJPage() {
    return location.pathname.includes('order_multi_print_ktj_logistics');
  }

  // 通知
  function notify(msg) {
    alert(`[BV SHOP 出貨助手] ${msg}`);
  }

  // 方案 A: 直接截取 PDF 顯示區域
  async function captureVisiblePDF() {
    try {
      console.log('使用截圖方案...');
      
      // 找到 PDF 顯示元素
      const pdfFrame = document.querySelector('embed, object, iframe');
      if (!pdfFrame) {
        throw new Error('找不到 PDF 顯示元素');
      }

      // 取得訂單資訊
      const urlParams = new URLSearchParams(location.search);
      const orderIds = urlParams.get('ids')?.split(',') || [];
      
      // 建立截圖資料
      const shippingData = [];
      
      // 如果是單頁，直接截圖
      const rect = pdfFrame.getBoundingClientRect();
      
      // 建立 canvas
      const canvas = document.createElement('canvas');
      canvas.width = rect.width * 2; // 2x 解析度
      canvas.height = rect.height * 2;
      const ctx = canvas.getContext('2d');
      
      // 白色背景
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // 通知使用者
      notify('PDF 無法自動解析，請手動擷取畫面或使用列印功能');
      
      // 提供替代方案
      const orderNo = orderIds[0] || `KTJ-${Date.now()}`;
      shippingData.push({
        html: `<div class="bv-shipping-wrapper" style="width:100%;max-width:105mm;padding:10px;border:1px dashed #ccc;">
                <p style="text-align:center;color:#666;">
                  嘉里大榮物流單<br>
                  訂單編號: ${orderNo}<br>
                  <br>
                  請使用瀏覽器列印功能<br>
                  或手動擷取畫面
                </p>
               </div>`,
        orderNo: orderNo,
        serviceCode: `KTJ${orderNo}`,
        width: '105mm',
        height: '148mm',
        index: 0,
        provider: 'ktj',
        isPlaceholder: true
      });

      // 儲存
      await chrome.storage.local.set({
})();
